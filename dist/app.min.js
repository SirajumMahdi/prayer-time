const PRAYER_NAMES=["Fajr","Dhuhr","Asr","Maghrib","Isha"],PRAYER_ICONS={Fajr:"üåÖ",Dhuhr:"‚òÄÔ∏è",Asr:"üå§Ô∏è",Maghrib:"üåÖ",Isha:"üåô"},CACHE_KEY="prayerTimesCache",LOCATION_KEY="userLocation",THEME_KEY="theme",NOTIFICATION_KEY="notificationSettings",SETTINGS_KEY="prayerSettings",LANG_KEY="language",TOTAL_QURAN_VERSES=6236,HIJRI_MONTHS_BN=["‡¶Æ‡ßÅ‡¶π‡¶æ‡¶∞‡¶∞‡¶Æ","‡¶∏‡¶´‡¶∞","‡¶∞‡¶¨‡¶ø‡¶â‡¶≤ ‡¶Ü‡¶â‡ßü‡¶æ‡¶≤","‡¶∞‡¶¨‡¶ø‡¶â‡¶∏ ‡¶∏‡¶æ‡¶®‡¶ø","‡¶ú‡¶Æ‡¶æ‡¶¶‡¶ø‡¶â‡¶≤ ‡¶Ü‡¶â‡ßü‡¶æ‡¶≤","‡¶ú‡¶Æ‡¶æ‡¶¶‡¶ø‡¶â‡¶∏ ‡¶∏‡¶æ‡¶®‡¶ø","‡¶∞‡¶ú‡¶¨","‡¶∂‡¶æ‡¶¨‡¶æ‡¶®","‡¶∞‡¶Æ‡¶ú‡¶æ‡¶®","‡¶∂‡¶æ‡¶ì‡ßü‡¶æ‡¶≤","‡¶ú‡¶ø‡¶≤‡¶ï‡¶¶","‡¶ú‡¶ø‡¶≤‡¶π‡¶ú"],TRANSLATIONS={en:{appTitle:"Prayer Times",locationPermission:"Prayer Times",now:"Now",remaining:"Remaining",timeRemaining:"Time Remaining",sehriEnds:"Sehri Ends",iftar:"Iftar",todaysSchedule:"Today's Schedule",fajr:"Fajr",dhuhr:"Dhuhr",asr:"Asr",maghrib:"Maghrib",isha:"Isha",newVerse:"New Verse",changeLocation:"Change Location",save:"Save",cancel:"Cancel",prayerNotifications:"üîî Prayer Notifications",notificationDesc:"Set your preferred notification time for each prayer.",enableNotifications:"Enable Notifications",to:"to",notificationHint:"Leave times empty to skip notification for that prayer.",notificationError:"Please enter times within each prayer's window.",saveAllSettings:"Save",timeForPrayer:"Time for Prayer",focusPrayer:"Focus on your prayer",settingsTitle:"Settings",settingsDesc:"Customize your prayer calculation methods.",calcMethod:"Calculation Method",asrMethod:"Asr Method",standard:"Others",hanafi:"Hanafi",hijriAdj:"Hijri Date Adjustment",hijriAdjHint:"Adjust date by +/- days if needed.",saveSettings:"Save Settings"},bn:{appTitle:"‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶∏‡ßÇ‡¶ö‡¶ø",locationPermission:"‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶∏‡ßÇ‡¶ö‡¶ø",now:"‡¶è‡¶ñ‡¶®",remaining:"‡¶¨‡¶æ‡¶ï‡¶ø",timeRemaining:"‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßü",sehriEnds:"‡¶∏‡ßá‡¶π‡¶∞‡¶ø‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶∏‡¶Æ‡ßü",iftar:"‡¶á‡¶´‡¶§‡¶æ‡¶∞",todaysSchedule:"‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶∏‡ßÇ‡¶ö‡¶ø",fajr:"‡¶´‡¶ú‡¶∞",dhuhr:"‡¶Ø‡ßã‡¶π‡¶∞",asr:"‡¶Ü‡¶∏‡¶∞",maghrib:"‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨",isha:"‡¶á‡¶∂‡¶æ",newVerse:"‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡ßü‡¶æ‡¶§",changeLocation:"‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®",save:"‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®",cancel:"‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®",prayerNotifications:"üîî ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®",notificationDesc:"‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",enableNotifications:"‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®",to:"‡¶•‡ßá‡¶ï‡ßá",notificationHint:"‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡¶æ ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶Æ‡ßü ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§",notificationError:"‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶∏‡¶Æ‡ßü‡¶∏‡ßÄ‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶Æ‡ßü ‡¶¶‡¶ø‡¶®‡•§",saveAllSettings:"‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®",timeForPrayer:"‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶π‡ßü‡ßá‡¶õ‡ßá",focusPrayer:"‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá ‡¶Æ‡¶®‡ßã‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®",settingsTitle:"‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏",settingsDesc:"‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",calcMethod:"‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø",asrMethod:"‡¶Ü‡¶∏‡¶∞ ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø",standard:"‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø",hanafi:"‡¶π‡¶æ‡¶®‡¶æ‡¶´‡¶ø",hijriAdj:"‡¶π‡¶ø‡¶ú‡¶∞‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡ßü",hijriAdjHint:"‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ¬± ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",saveSettings:"‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®"}};let currentLang="en",prayerTimes={},countdownInterval=null,notificationDismissedFor=null;function initTheme(){const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;("dark"===e||!e&&t)&&document.body.classList.add("dark"),updateThemeButton()}function updateThemeButton(){const e=document.body.classList.contains("dark"),t=document.querySelector(".theme-text");t&&(t.textContent=e?"Dark":"Light")}function toggleTheme(){const e=document.body.classList.toggle("dark");localStorage.setItem("theme",e?"dark":"light"),updateThemeButton()}function getSavedLocation(){const e=localStorage.getItem(LOCATION_KEY);return e?JSON.parse(e):null}function saveLocation(e,t){localStorage.setItem(LOCATION_KEY,JSON.stringify({city:e,country:t}))}async function detectLocation(){return new Promise(e=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(async t=>{try{const{latitude:n,longitude:a}=t.coords,o=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${n}&longitude=${a}&localityLanguage=en`),r=await o.json();e({city:r.city||r.locality||"Unknown",country:r.countryName||"Unknown"})}catch(t){console.error("Reverse geocoding failed:",t),e(null)}},()=>e(null),{timeout:1e4}):e(null)})}async function initLocation(){const e=document.querySelector("#cardLocation");let t=getSavedLocation();t||(e&&(e.textContent="Detecting..."),t=await detectLocation(),t||(t={city:"Dhaka",country:"Bangladesh"}),saveLocation(t.city,t.country));const n=`${t.city}, ${t.country}`;return e&&(e.textContent=n),t}function initLanguage(){const e=localStorage.getItem(LANG_KEY);e&&TRANSLATIONS[e]&&(currentLang=e),updateLanguageUI()}function toggleLanguage(){currentLang="en"===currentLang?"bn":"en",localStorage.setItem(LANG_KEY,currentLang),updateLanguageUI(),prayerTimes&&Object.keys(prayerTimes).length>0&&(updatePrayerTimesDisplay(prayerTimes),updateCurrentPrayerCard(prayerTimes),updateDateDisplay({}),loadPrayerTimes()),fetchRandomAyah()}function getTranslation(e){return TRANSLATIONS[currentLang][e]||e}function updateLanguageUI(){const e=document.getElementById("langToggle");e&&(e.textContent="en"===currentLang?"BN":"EN"),"bn"===currentLang?(document.body.classList.remove("font-serif"),document.body.classList.add("font-bangla")):(document.body.classList.remove("font-bangla"),document.body.classList.add("font-serif")),document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");TRANSLATIONS[currentLang][t]&&(e.textContent=TRANSLATIONS[currentLang][t])})}function getCacheKey(e,t){const n=(new Date).toISOString().split("T")[0];return`${CACHE_KEY}_${e}_${t}_${n}`}function getCachedPrayerTimes(e,t){const n=getCacheKey(e,t),a=localStorage.getItem(n);return a?JSON.parse(a):null}function cachePrayerTimes(e,t,n){const a=getCacheKey(e,t);localStorage.setItem(a,JSON.stringify(n))}async function fetchPrayerTimes(e,t){const n=getCachedPrayerTimes(e,t);if(n)return n;try{const n=getSettings(),a=`https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(e)}&country=${encodeURIComponent(t)}&method=${n.method}&school=${n.school}`,o=await fetch(a),r=await o.json();if(200===r.code){const n={timings:r.data.timings,date:r.data.date};return cachePrayerTimes(e,t,n),n}throw new Error("API returned error")}catch(e){return console.error("Failed to fetch prayer times:",e),null}}function parseTime(e){const t=e.split(" ")[0],[n,a]=t.split(":").map(Number),o=new Date;return new Date(o.getFullYear(),o.getMonth(),o.getDate(),n,a,0)}function formatCountdown(e){if(e<0)return"00:00:00";const t=Math.floor(e/1e3);return localizeNumber([Math.floor(t/3600),Math.floor(t%3600/60),t%60].map(e=>e.toString().padStart(2,"0")).join(":"))}function formatTime12h_OLD(e){return e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})}function getCurrentPrayer(e){const t=new Date;for(let n=PRAYER_NAMES.length-1;n>=0;n--){const a=PRAYER_NAMES[n],o=parseTime(e[a]);if(t>=o){const t=(n+1)%PRAYER_NAMES.length;let r=parseTime(e[PRAYER_NAMES[t]]);return 0===t&&r.setDate(r.getDate()+1),{name:a,startTime:o,endTime:r,icon:PRAYER_ICONS[a]}}}const n=parseTime(e.Isha);n.setDate(n.getDate()-1);return{name:"Isha",startTime:n,endTime:parseTime(e.Fajr),icon:PRAYER_ICONS.Isha}}function getNextPrayer(e){const t=new Date;for(const n of PRAYER_NAMES){const a=parseTime(e[n]);if(a>t)return{name:n,time:a,icon:PRAYER_ICONS[n]}}const n=parseTime(e.Fajr);return n.setDate(n.getDate()+1),{name:"Fajr",time:n,icon:PRAYER_ICONS.Fajr}}function updateDateDisplay(e){const t=document.getElementById("gregorianDate"),n=document.getElementById("hijriDate"),a=new Date,o="bn"===currentLang?"bn-BD":"en-US";if(t.textContent=a.toLocaleDateString(o,{weekday:"long",day:"numeric",month:"long",year:"numeric"}),e&&e.hijri){let t={...e.hijri};const a=getSettings(),o=parseInt(a.adjustment)||0;if(0!==o){let e=parseInt(t.day),n=parseInt(t.month.number),a=parseInt(t.year);e+=o,e>30?(e-=30,n+=1,n>12&&(n=1,a+=1)):e<1&&(e+=30,n-=1,n<1&&(n=12,a-=1)),t.day=e.toString(),t.month.number=n}let r=t.month.en;if("bn"===currentLang&&t.month.number){const e=parseInt(t.month.number)-1;e>=0&&e<HIJRI_MONTHS_BN.length&&(r=HIJRI_MONTHS_BN[e])}const i=localizeNumber(t.day),c=localizeNumber(t.year);n.textContent=`${i} ${r} ${c} AH`}}function updatePrayerTimesDisplay(e){const t=new Date,n=getCurrentPrayer(e);PRAYER_NAMES.forEach((a,o)=>{const r=document.getElementById(a.toLowerCase()),i=r.querySelector(".prayer-start"),c=(r.querySelector(".prayer-end"),r.querySelector(".prayer-status")),s=parseTime(e[a]),d=(o+1)%PRAYER_NAMES.length,l=PRAYER_NAMES[d];let m=parseTime(e[l]);0===d&&m.setDate(m.getDate()+1),i.textContent=formatTime12h(s),r.classList.remove("current","passed"),c.textContent="",c.className="prayer-status w-6 h-6 rounded-full flex items-center justify-center text-xs",a===n.name?(r.classList.add("current"),c.textContent="‚óè"):s<t&&a!==n.name&&(r.classList.add("passed"),c.textContent="‚úì")})}function updateCurrentPrayerCard(e){const t=getCurrentPrayer(e),n=new Date,a=t.endTime-n;document.getElementById("currentPrayerName").textContent=getTranslation(t.name.toLowerCase())||t.name,document.getElementById("currentPrayerCountdown").textContent=formatCountdown(a);const o=document.getElementById("currentPrayerTime");if(o){const e=formatTime12h(t.startTime);o.textContent="bn"===currentLang?`${e}-‡¶è ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá`:`Started at ${e}`}document.getElementById("headerPrayerName").textContent=getTranslation(t.name.toLowerCase())||t.name,document.getElementById("headerCountdown").textContent=formatCountdown(a);const r=t.endTime-t.startTime,i=n-t.startTime,c=Math.min(100,Math.max(0,i/r*100)),s=document.getElementById("currentPrayerProgress");if(s){const e=251.2,t=e-e*(c/100);s.style.strokeDashoffset=t}const d=document.getElementById(t.name.toLowerCase());if(d){const e=d.querySelector(".prayer-progress");e&&(e.style.width=`${c}%`)}}function updateSehriIftar(e){document.getElementById("sehriTime").textContent=formatTime12h(parseTime(e.Fajr)),document.getElementById("iftarTime").textContent=formatTime12h(parseTime(e.Maghrib))}function startCountdown(e){countdownInterval&&clearInterval(countdownInterval),updateCurrentPrayerCard(e),updatePrayerTimesDisplay(e),countdownInterval=setInterval(()=>{updateCurrentPrayerCard(e);const t=new Date,n=(getCurrentPrayer(e),getNextPrayer(e));Math.abs(n.time.getTime()-t.getTime())<1e3&&updatePrayerTimesDisplay(e)},1e3)}async function fetchRandomAyah(){const e=document.getElementById("ayahLoader"),t=document.getElementById("ayahContent");e.classList.remove("hidden"),t.classList.add("hidden");try{const n=Math.floor(6236*Math.random())+1,a=`https://api.alquran.cloud/v1/ayah/${n}/editions/quran-uthmani,${"bn"===currentLang?"bn.bengali":"en.sahih"}`,o=await fetch(a),r=await o.json();if(200===r.code){const n=r.data[0],a=r.data[1];document.getElementById("arabicText").textContent=n.text,document.getElementById("englishText").textContent=`"${a.text}"`;const o=a.surah.englishName,i=localizeNumber(a.surah.number),c=localizeNumber(a.numberInSurah);document.getElementById("ayahReference").textContent=`‚Äî ${o} ${i}:${c}`,e.classList.add("hidden"),t.classList.remove("hidden")}}catch(t){console.error("Failed to fetch ayah:",t),e.innerHTML='<p class="text-red-400">Failed to load verse</p>'}}function showLocationForm(){document.getElementById("locationForm").classList.remove("hidden")}function hideLocationForm(){document.getElementById("locationForm").classList.add("hidden")}async function handleLocationSave(){const e=document.getElementById("cityInput").value.trim(),t=document.getElementById("countryInput").value.trim();if(!e||!t)return void alert("Please enter both city and country");saveLocation(e,t);const n=document.querySelector("#cardLocation");n&&(n.textContent=`${e}, ${t}`),loadPrayerTimes()}function getNotificationSettings(){const e={enabled:!0,prayers:{Fajr:{start:"",end:""},Dhuhr:{start:"",end:""},Asr:{start:"",end:""},Maghrib:{start:"",end:""},Isha:{start:"",end:""}}},t=localStorage.getItem(NOTIFICATION_KEY);if(!t)return e;try{const n=JSON.parse(t);return{enabled:void 0!==n.enabled?n.enabled:e.enabled,prayers:{Fajr:{...e.prayers.Fajr,...n.prayers?.Fajr||{}},Dhuhr:{...e.prayers.Dhuhr,...n.prayers?.Dhuhr||{}},Asr:{...e.prayers.Asr,...n.prayers?.Asr||{}},Maghrib:{...e.prayers.Maghrib,...n.prayers?.Maghrib||{}},Isha:{...e.prayers.Isha,...n.prayers?.Isha||{}}}}}catch(t){return console.error("Failed to parse notification settings:",t),e}}function saveNotificationSettingsToStorage(e){localStorage.setItem(NOTIFICATION_KEY,JSON.stringify(e))}function formatTimeFor24h(e){return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}function formatTime12h(e){const t=e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return"bn"===currentLang?t.replace("AM","").replace("PM","").trim().replace(/0/g,"‡ß¶").replace(/1/g,"‡ßß").replace(/2/g,"‡ß®").replace(/3/g,"‡ß©").replace(/4/g,"‡ß™").replace(/5/g,"‡ß´").replace(/6/g,"‡ß¨").replace(/7/g,"‡ß≠").replace(/8/g,"‡ßÆ").replace(/9/g,"‡ßØ"):t}function localizeNumber(e){return"bn"!==currentLang?e:e.toString().replace(/0/g,"‡ß¶").replace(/1/g,"‡ßß").replace(/2/g,"‡ß®").replace(/3/g,"‡ß©").replace(/4/g,"‡ß™").replace(/5/g,"‡ß´").replace(/6/g,"‡ß¨").replace(/7/g,"‡ß≠").replace(/8/g,"‡ßÆ").replace(/9/g,"‡ßØ")}function parseTimeInput(e){if(!e)return null;const[t,n]=e.split(":").map(Number),a=new Date;return new Date(a.getFullYear(),a.getMonth(),a.getDate(),t,n,0)}function getPrayerEndTime(e,t){const n=(PRAYER_NAMES.indexOf(e)+1)%PRAYER_NAMES.length;let a=parseTime(t[PRAYER_NAMES[n]]);return 0===n&&a.setDate(a.getDate()+1),a}function showNotificationSettings(){const e=getNotificationSettings();document.getElementById("notificationEnabled").checked=e.enabled,prayerTimes&&Object.keys(prayerTimes).length>0&&PRAYER_NAMES.forEach(t=>{const n=parseTime(prayerTimes[t]),a=getPrayerEndTime(t,prayerTimes),o=formatTimeFor24h(n),r=formatTimeFor24h(a),i=document.getElementById(`${t.toLowerCase()}Window`);i&&(i.textContent=`${formatTime12h(n)} - ${formatTime12h(a)}`);const c=e.prayers[t]||{start:"",end:""},s=document.getElementById(`${t.toLowerCase()}Start`),d=document.getElementById(`${t.toLowerCase()}End`);s&&(s.min=o,s.max=r,s.value=c.start||""),d&&(d.min=o,d.max=r,d.value=c.end||"")}),document.getElementById("notificationSettings").classList.remove("hidden")}function hideNotificationSettings(){document.getElementById("notificationSettings").classList.add("hidden")}function saveNotificationSettings(){const e={};let t=!1;const n=document.getElementById("notificationError");if(n&&n.classList.add("hidden"),PRAYER_NAMES.forEach(e=>{const t=document.getElementById(`${e.toLowerCase()}Start`),n=document.getElementById(`${e.toLowerCase()}End`);t&&t.classList.remove("border-red-500"),n&&n.classList.remove("border-red-500")}),PRAYER_NAMES.forEach(n=>{const a=document.getElementById(`${n.toLowerCase()}Start`),o=document.getElementById(`${n.toLowerCase()}End`);let r=a?a.value:"",i=o?o.value:"",c=!1;if(prayerTimes&&(r||i)){const e=parseTime(prayerTimes[n]),s=getPrayerEndTime(n,prayerTimes),d=formatTimeFor24h(e),l=formatTimeFor24h(s);r&&(r<d||r>l)&&(a&&a.classList.add("border-red-500"),c=!0),i&&(i<d||i>l)&&(o&&o.classList.add("border-red-500"),c=!0),r&&i&&r>i&&(o&&o.classList.add("border-red-500"),c=!0),c&&(t=!0)}e[n]={start:c?"":r,end:c?"":i}}),t)return void(n&&n.classList.remove("hidden"));saveNotificationSettingsToStorage({enabled:document.getElementById("notificationEnabled").checked,prayers:e}),hideNotificationSettings(),scheduleNextNotificationCheck()}function getSettings(){const e=localStorage.getItem(SETTINGS_KEY);return e?JSON.parse(e):{method:1,school:1,adjustment:0}}function saveSettingsToStorage(e){localStorage.setItem(SETTINGS_KEY,JSON.stringify(e))}function showSettings(){const e=getSettings(),t=document.getElementById("calcMethod");t&&(t.value=e.method);document.getElementsByName("asrMethod").forEach(t=>{t.checked=parseInt(t.value)===e.school});const n=document.getElementById("hijriAdj");n&&(n.value=e.adjustment),document.getElementById("settingsModal").classList.remove("hidden")}function hideSettings(){document.getElementById("settingsModal").classList.add("hidden")}function saveSettings(){const e=parseInt(document.getElementById("calcMethod").value);let t=0;document.getElementsByName("asrMethod").forEach(e=>{e.checked&&(t=parseInt(e.value))});const n=parseInt(document.getElementById("hijriAdj").value);saveSettingsToStorage({method:e,school:t,adjustment:n}),hideSettings(),Object.keys(localStorage).forEach(e=>{e.startsWith(CACHE_KEY)&&localStorage.removeItem(e)}),loadPrayerTimes()}let notificationCountdownInterval=null;function updateNotificationCountdown(e){const t=document.getElementById("notificationCountdown");if(!t)return;const n=e-new Date;if(n<=0)return void(t.textContent="0:00");const a=Math.floor(n/6e4),o=Math.floor(n%6e4/1e3);t.textContent=`${a}:${o.toString().padStart(2,"0")}`}function showPrayerNotification(e,t,n){document.getElementById("notificationPrayerName").textContent=getTranslation(e.toLowerCase())||e,document.getElementById("notificationIcon").textContent=t,updateNotificationCountdown(n),notificationCountdownInterval&&clearInterval(notificationCountdownInterval),notificationCountdownInterval=setInterval(()=>{updateNotificationCountdown(n)},1e3),document.getElementById("prayerNotification").classList.remove("hidden"),document.body.style.overflow="hidden"}function hidePrayerNotification(){notificationCountdownInterval&&(clearInterval(notificationCountdownInterval),notificationCountdownInterval=null),document.getElementById("prayerNotification").classList.add("hidden"),document.body.style.overflow=""}function dismissNotification(){const e=getCurrentPrayer(prayerTimes);notificationDismissedFor=e.name,hidePrayerNotification()}function checkNotificationTrigger(e){const t=getNotificationSettings();if(!t.enabled)return;const n=new Date,a=getCurrentPrayer(e);if(notificationDismissedFor===a.name)return;const o=t.prayers[a.name];if(!o||!o.start||!o.end)return;const r=parseTimeInput(o.start),i=parseTimeInput(o.end);if(!r||!i)return;const c=n>=r&&n<=i,s=n>=a.startTime&&n<a.endTime;if(c&&s)showPrayerNotification(a.name,a.icon,i);else{document.getElementById("prayerNotification").classList.contains("hidden")||hidePrayerNotification()}notificationDismissedFor&&notificationDismissedFor!==a.name&&(notificationDismissedFor=null)}let notificationCheckTimeout=null;function scheduleNextNotificationCheck(){notificationCheckTimeout&&clearTimeout(notificationCheckTimeout);let e=6e4;const t=getNotificationSettings();if(!t.enabled||!prayerTimes)return void(notificationCheckTimeout=setTimeout(()=>{scheduleNextNotificationCheck()},e));const n=new Date;let a=null,o=1/0;PRAYER_NAMES.forEach(e=>{const r=t.prayers[e];if(!r||!r.start||!r.end)return;const i=parseTimeInput(r.start),c=parseTimeInput(r.end);i&&c&&(i>n&&i-n<o&&(o=i-n,a=i),c>n&&c-n<o&&(o=c-n,a=c))}),e=a?Math.max(0,a-n)+100:6e4,notificationCheckTimeout=setTimeout(()=>{checkNotificationTrigger(prayerTimes),scheduleNextNotificationCheck()},e)}async function loadPrayerTimes(){const e=getSavedLocation()||{city:"Dhaka",country:"Bangladesh"},t=await fetchPrayerTimes(e.city,e.country);t&&(prayerTimes=t.timings,updateDateDisplay(t.date),updatePrayerTimesDisplay(prayerTimes),updateSehriIftar(prayerTimes),startCountdown(prayerTimes),scheduleNextNotificationCheck())}async function init(){initTheme(),initLanguage();const e=(e,t,n)=>{const a=document.getElementById(e);a?a.addEventListener(t,n):console.warn(`Element ${e} not found`)};e("themeToggle","click",toggleTheme),e("langToggle","click",toggleLanguage),e("newAyahBtn","click",fetchRandomAyah),e("changeLocationBtn","click",showLocationForm),e("cancelLocationBtn","click",hideLocationForm),e("saveLocationBtn","click",handleLocationSave),e("notificationSettingsBtn","click",showNotificationSettings),e("dismissNotification","click",dismissNotification),e("settingsBtn","click",showSettings),e("calendarBtn","click",showCalendar),e("prevMonth","click",()=>navigateMonth(-1)),e("nextMonth","click",()=>navigateMonth(1)),e("downloadCalendar","click",downloadCalendar),e("statsBtn","click",showStatsModal),e("resetStats","click",resetPrayerStats),document.querySelectorAll(".prayer-track-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();togglePrayerCompletion(e.dataset.prayer)})}),document.getElementById("hijriInc")?.addEventListener("click",()=>{const e=document.getElementById("hijriAdj");e&&(e.value=parseInt(e.value)+1)}),document.getElementById("hijriDec")?.addEventListener("click",()=>{const e=document.getElementById("hijriAdj");e&&(e.value=parseInt(e.value)-1)}),document.getElementById("countryInput")?.addEventListener("keypress",e=>{"Enter"===e.key&&handleLocationSave()}),await initLocation(),await loadPrayerTimes(),await fetchRandomAyah(),updatePrayerTrackingUI();const t=document.getElementById("headerPrayerInfo"),n=document.getElementById("currentPrayerCard");if(t&&n){new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(t.classList.add("opacity-0","pointer-events-none"),t.classList.remove("opacity-100")):(t.classList.remove("opacity-0","pointer-events-none"),t.classList.add("opacity-100"))})},{threshold:.1}).observe(n)}}const PRAYER_LOG_KEY="prayer_log";function getTodayDateKey(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function getPrayerLog(){const e=localStorage.getItem(PRAYER_LOG_KEY);return e?JSON.parse(e):{}}function savePrayerLog(e){localStorage.setItem(PRAYER_LOG_KEY,JSON.stringify(e))}function togglePrayerCompletion(e){const t=getTodayDateKey(),n=getPrayerLog();n[t]||(n[t]={}),n[t][e]=!n[t][e],savePrayerLog(n),updatePrayerTrackingUI()}function updatePrayerTrackingUI(){const e=getTodayDateKey(),t=getPrayerLog()[e]||{};document.querySelectorAll(".prayer-track-btn").forEach(e=>{const n=e.dataset.prayer;t[n]?e.classList.add("completed"):e.classList.remove("completed")})}function calculateStreak(){const e=getPrayerLog(),t=Object.keys(e).sort().reverse();let n=0,a=0,o=0;const r=new Date;r.setHours(0,0,0,0);for(let i=0;i<t.length;i++){const c=e[t[i]];if(5===PRAYER_NAMES.filter(e=>c[e]).length){o++;const e=new Date(t[i]);e.setHours(0,0,0,0);const a=new Date(r);a.setDate(a.getDate()-i),e.getTime()===a.getTime()&&(n=o)}else o=0;a=Math.max(a,o)}return{currentStreak:n,bestStreak:a}}function getWeeklyStats(){const e=getPrayerLog(),t=[],n=new Date;for(let a=6;a>=0;a--){const o=new Date(n);o.setDate(o.getDate()-a);const r=`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`,i=e[r]||{},c=PRAYER_NAMES.filter(e=>i[e]).length;t.push({date:r,dayName:o.toLocaleDateString("en-US",{weekday:"short"}),completed:c})}return t}function getMonthlyCount(){const e=getPrayerLog(),t=new Date,n=t.getMonth(),a=t.getFullYear();let o=0;return Object.keys(e).forEach(t=>{const r=new Date(t);if(r.getMonth()===n&&r.getFullYear()===a){const n=e[t];o+=PRAYER_NAMES.filter(e=>n[e]).length}}),o}function showStatsModal(){const{currentStreak:e,bestStreak:t}=calculateStreak(),n=getWeeklyStats(),a=getMonthlyCount(),o=getPrayerLog()[getTodayDateKey()]||{},r=PRAYER_NAMES.filter(e=>o[e]).length;document.getElementById("currentStreak").textContent=e,document.getElementById("bestStreak").textContent=t,document.getElementById("todayCount").textContent=`${r}/5`,document.getElementById("todayProgressBar").style.width=r/5*100+"%";const i=document.getElementById("weeklyChart"),c=document.getElementById("weeklyLabels");i.innerHTML="",c.innerHTML="",n.forEach(e=>{const t=document.createElement("div");t.className="flex-1 flex flex-col items-center";const n=document.createElement("div");n.className="stats-bar "+(0===e.completed?"empty":""),n.style.height=e.completed/5*100+"%",n.style.minHeight=e.completed>0?"4px":"2px",t.appendChild(n),i.appendChild(t);const a=document.createElement("div");a.className="stats-label flex-1",a.textContent=e.dayName,c.appendChild(a)}),document.getElementById("monthlyCount").textContent=`${a} prayers`,document.getElementById("statsModal").classList.remove("hidden")}function hideStats(){document.getElementById("statsModal").classList.add("hidden")}function resetPrayerStats(){confirm("Are you sure you want to reset all prayer tracking data?")&&(localStorage.removeItem(PRAYER_LOG_KEY),updatePrayerTrackingUI(),showStatsModal())}const CALENDAR_CACHE_KEY="calendar_cache";let calendarYear=(new Date).getFullYear(),calendarMonth=(new Date).getMonth()+1,calendarData=null;function getCalendarCacheKey(e,t,n,a){return`calendar_cache_${e}_${t}_${n}_${a}`}function getCachedCalendarData(e,t,n,a){const o=getCalendarCacheKey(e,t,n,a),r=localStorage.getItem(o);return r?JSON.parse(r):null}function cacheCalendarData(e,t,n,a,o){const r=getCalendarCacheKey(e,t,n,a);localStorage.setItem(r,JSON.stringify(o))}async function fetchMonthlyPrayerTimes(e,t){const n=getSavedLocation()||{city:"Dhaka",country:"Bangladesh"},a=getSettings(),o=getCachedCalendarData(e,t,n.city,n.country);if(o)return o;try{const o=`https://api.aladhan.com/v1/calendarByCity/${e}/${t}?city=${encodeURIComponent(n.city)}&country=${encodeURIComponent(n.country)}&method=${a.method}&school=${a.school}`,r=await fetch(o),i=await r.json();if(200===i.code)return cacheCalendarData(e,t,n.city,n.country,i.data),i.data}catch(e){console.error("Failed to fetch monthly calendar:",e)}return null}async function renderCalendar(e,t){const n=document.getElementById("calendarGrid"),a=document.getElementById("calendarLoader"),o=document.getElementById("calendarTitle");n.innerHTML="",a.classList.remove("hidden");o.textContent=`${["January","February","March","April","May","June","July","August","September","October","November","December"][t-1]} ${e}`;const r=await fetchMonthlyPrayerTimes(e,t);if(a.classList.add("hidden"),!r)return void(n.innerHTML='<div class="col-span-7 text-center py-8 text-[#636e72]">Failed to load calendar data</div>');calendarData=r;const i=new Date(e,t-1,1).getDay(),c=new Date,s=c.getFullYear()===e&&c.getMonth()+1===t;for(let e=0;e<i;e++){const e=document.createElement("div");e.className="calendar-day empty",n.appendChild(e)}r.forEach((e,t)=>{const a=t+1,o=s&&c.getDate()===a,r=document.createElement("div");r.className="calendar-day "+(o?"today":"");const i=e.timings;r.innerHTML=`\n            <div class="day-number">${a}</div>\n            <div class="prayer-times">\n                <span>F: ${i.Fajr.split(" ")[0]}</span>\n                <span>D: ${i.Dhuhr.split(" ")[0]}</span>\n                <span>A: ${i.Asr.split(" ")[0]}</span>\n                <span>M: ${i.Maghrib.split(" ")[0]}</span>\n                <span>I: ${i.Isha.split(" ")[0]}</span>\n            </div>\n        `,n.appendChild(r)})}function showCalendar(){calendarYear=(new Date).getFullYear(),calendarMonth=(new Date).getMonth()+1,document.getElementById("calendarModal").classList.remove("hidden"),renderCalendar(calendarYear,calendarMonth)}function hideCalendar(){document.getElementById("calendarModal").classList.add("hidden")}function navigateMonth(e){calendarMonth+=e,calendarMonth>12?(calendarMonth=1,calendarYear++):calendarMonth<1&&(calendarMonth=12,calendarYear--),renderCalendar(calendarYear,calendarMonth)}function downloadCalendar(){window.print()}document.addEventListener("DOMContentLoaded",init);